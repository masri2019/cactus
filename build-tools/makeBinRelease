#!/bin/bash
# Generate release tar file static-compiled binaries 
# Must be run after tree is tagged and pushed to master.
# Use --keep to keep working directory for debugging.

set -beEu -o pipefail
mydir=$(dirname $(which $0))
source ${mydir}/releaseLib.sh

keep=no
if [ $1 = '--keep' ] ; then
    keep=yes
fi

buildDir=$(realpath -m build)
binBuildDir="${buildDir}/bin-tmp"

set -x
rm -rf ${binBuildDir}
mkdir -p ${binBuildDir}
cd ${binBuildDir}
git clone --recursive https://github.com/ComparativeGenomicsToolkit/cactus.git
cd cactus
git fetch --tags origin

REL_TAG=$(getLatestReleaseTag)
git checkout "${REL_TAG}"
git submodule update --init --recursive


# There was a recomendation of using -march=nehalem increases portability,
# however this is not recognized by GCC 4.8

make -j $(nproc) static

binPackageDir=cactus-bin-${REL_TAG}
virtualenv -p ${PYTHON} venv
source venv/bin/activate
mkdir ${binPackageDir}
cd ${binPackageDir}
cp ${binBuildDir}/cactus/BIN-INSTALL.md .
mkdir wheels
cd wheels
${PIP} install -U pip
${PIP} wheel --no-deps ../..
cd ..
deactivate
cp -r ../bin ../src ../examples .
cp ../*.md ../*.py ../*.txt .
# needed for pip install
mkdir submodules
cp -r ../submodules/sonLib submodules/
cp -r ../.git .
strip -d bin/* 2> /dev/null || true
cd ..
tar -czf ${buildDir}/cactus-bin-${REL_TAG}.tar.gz ${binPackageDir}
if [ "$keep" = "no" ] ; then
    rm -Rf ${binBuildDir}
fi
